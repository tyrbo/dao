#!/bin/bash
set -e

not_installed () {
  ! hash $1 &> /dev/null;
}

# Install homebrew if not installed
if not_installed 'brew'; then
  echo "Installing homebrew..."
  ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

# Update homebrew recipes
echo "Updating homebrew recipes..."
brew update

# Install homebrew cask
brew install caskroom/cask/brew-cask

# Install vagrant and virtualbox
if not_installed 'VirtualBox'; then
  echo "Installing virtualbox..."
  brew cask install virtualbox
fi

if not_installed 'vagrant'; then
  echo "Installing vagrant..."
  brew cask install vagrant
fi

# Install git
if not_installed 'git'; then
  echo "Installing git..."
  brew install git
fi

# Install docker and fig
if not_installed 'boot2docker'; then
  echo "Installing boot2docker and docker..."
  brew install boot2docker
fi

# Set profile
if [ ! -f $HOME/.boot2docker/profile ]; then
  echo 'ISOURL = "https://api.github.com/repos/tyrbo/dao-boot2docker/releases"' >> $HOME/.boot2docker/profile
else
  echo "It seems you already have a boot2docker profile. Please add the following line to the file:"
  echo
  echo 'ISOURL = "https://api.github.com/repos/tyrbo/dao-boot2docker/releases"'
  echo
fi

boot2docker init
boot2docker up

if not_installed 'fig'; then
  echo "Installing fig..."
  brew install fig
fi

# Check out the repo
cd ~
git clone git@github.com:tyrbo/dao .bootstrap

# How to handle DOCKER_HOST and such...
echo
echo "In the next few lines, you should see mention of writing boot2docker cert files."
echo "Following, you should see several lines used to set environment variables."
echo "For ease of use, you should add those lines to your profile."
echo
boot2docker shellinit
echo
echo "For bash, this is usually ~/.bash_profile, for zshell ~/.zshrc, etc."
echo "Refer to your documentation if you are uncertain about where to place your value."
echo
